<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inventory</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-slate-950 text-slate-100">
  <main class="max-w-xl mx-auto p-4 space-y-4">
    <div id="authBar" class="flex items-center justify-between text-sm opacity-80"></div>

    <!-- Sign-in -->
    <section id="login" class="space-y-2">
      <h2 class="text-lg font-semibold">Sign in</h2>
      <input id="email" class="w-full px-3 py-2 rounded bg-slate-800" placeholder="Email">
      <input id="pass" type="password" class="w-full px-3 py-2 rounded bg-slate-800" placeholder="Password">
      <button id="loginBtn" class="px-4 py-2 rounded bg-blue-600">Sign in</button>
      <div id="toast" class="hidden mt-3 text-center text-sm"></div>
    </section>

    <!-- Product card -->
    <section id="product" class="hidden">
      <div class="rounded-2xl bg-slate-900/60 p-4">
        <div class="flex items-start gap-3">
          <img id="photo" class="w-20 h-20 rounded-xl object-cover bg-slate-800" alt=""/>
          <div>
            <h1 id="name" class="text-xl font-semibold"></h1>
            <div id="sku" class="text-xs opacity-70"></div>
            <div id="location" class="text-xs opacity-70"></div>
          </div>
        </div>

        <div class="mt-4 text-center">
          <div class="text-xs uppercase tracking-wider opacity-70">On Hand</div>
          <div id="qty" class="text-5xl font-bold my-2">–</div>
        </div>

        <!-- Adjustment controls -->
        <div class="mt-3 flex items-center justify-center gap-4">
          <button id="minusBtn" class="text-3xl w-20 h-20 rounded-2xl bg-slate-800">−</button>
          <button id="plusBtn"  class="text-3xl w-20 h-20 rounded-2xl bg-slate-800">+</button>
        </div>

        <!-- Pending + Submit/Cancel -->
        <div class="mt-3 flex items-center justify-center gap-3">
          <span id="pendingBadge" class="px-3 py-1 rounded-full text-sm bg-slate-800/70 hidden">Pending 0</span>
          <button id="submitBtn" class="px-4 py-2 rounded-xl bg-blue-600 disabled:opacity-40" disabled>Submit</button>
          <button id="cancelBtn" class="px-4 py-2 rounded-xl bg-slate-700 disabled:opacity-40" disabled>Cancel</button>
        </div>

        <div class="mt-3">
          <input id="note" placeholder="Optional note" class="w-full px-3 py-2 rounded-xl bg-slate-800/70"/>
        </div>

        <!-- History (audit log) -->
        <div class="mt-6">
          <h3 class="text-sm font-semibold mb-2">History</h3>
          <div class="max-h-64 overflow-auto rounded-xl bg-slate-900/40">
            <table class="w-full text-xs">
              <thead class="sticky top-0 bg-slate-900/70">
                <tr>
                  <th class="text-left px-3 py-2">Date/Time</th>
                  <th class="text-left px-3 py-2">User</th>
                  <th class="text-right px-3 py-2">Starting Qty</th>
                  <th class="text-right px-3 py-2">Change</th>
                  <th class="text-right px-3 py-2">Ending Qty</th>
                </tr>
              </thead>
              <tbody id="historyBody"></tbody>
            </table>
            <div id="historyEmpty" class="hidden p-3 text-xs opacity-70">No history yet.</div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { getDatabase, ref, onValue, runTransaction, push, update, serverTimestamp, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAy8uJsjPrdHKp60afCtnTdYGLHoYTEHyc",
      authDomain: "artsinventorymachine.firebaseapp.com",
      databaseURL: "https://artsinventorymachine-default-rtdb.firebaseio.com",
      projectId: "artsinventorymachine",
      storageBucket: "artsinventorymachine.firebasestorage.app",
      messagingSenderId: "1003904050464",
      appId: "1:1003904050464:web:5a35989900fbdc5fa72345",
      measurementId: "G-BEJKKJK9H5"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // Helpers
    const $ = (x)=>document.getElementById(x);
    const show = (el, yes)=> el.classList.toggle("hidden", !yes);
    const q = (k,d=null)=> new URLSearchParams(location.search).get(k) || d;
    const toastEl = document.getElementById("toast") || document.createElement("div");
    const toast=(m)=>{ toastEl.textContent=m; toastEl.className="mt-3 text-center text-sm"; show(toastEl,true); setTimeout(()=>show(toastEl,false),3000); };

    let pid = null, pending = 0;

    const loginSec = $("login"), prodSec = $("product"), authBar = $("authBar");
    const nameEl = $("name"), skuEl = $("sku"), locEl = $("location"), qtyEl = $("qty"), photoEl = $("photo");
    const minusBtn = $("minusBtn"), plusBtn = $("plusBtn"), noteEl = $("note");
    const pendingBadge = $("pendingBadge"), submitBtn = $("submitBtn"), cancelBtn = $("cancelBtn");
    const historyBody = $("historyBody"), historyEmpty = $("historyEmpty");

    function renderPending() {
      if (pending === 0) {
        pendingBadge.classList.add("hidden");
        submitBtn.disabled = true;
        cancelBtn.disabled = true;
        pendingBadge.textContent = "Pending 0";
      } else {
        pendingBadge.classList.remove("hidden");
        submitBtn.disabled = false;
        cancelBtn.disabled = false;
        const sign = pending > 0 ? "+" : "";
        pendingBadge.textContent = `Pending ${sign}${pending}`;
      }
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) { authBar.innerHTML = ""; show(loginSec, true); show(prodSec, false); return; }
      authBar.innerHTML = `Signed in as <b>${user.email}</b> — <button id="logout" class="underline">Sign out</button>`;
      document.getElementById("logout").onclick = () => signOut(auth);
      show(loginSec, false);

      pid = q("id") || "prod_demo";
      bindProduct(pid);
      subscribeHistory(pid);
      renderPending();
      show(prodSec, true);
    });

    $("loginBtn").onclick = async () => {
      try {
        await signInWithEmailAndPassword(auth, $("email").value.trim(), $("pass").value.trim());
      } catch(e) {
        toast(`Sign-in failed: ${e.code}`);
      }
    };

    function bindProduct(id){
      onValue(ref(db, `products/${id}`), (snap) => {
        if (!snap.exists()) { nameEl.textContent = "Not found"; return; }
        const p = snap.val();
        nameEl.textContent = p.name || "(unnamed)";
        skuEl.textContent = p.sku ? `SKU: ${p.sku}` : "";
        locEl.textContent = p.location ? `Location: ${p.location}` : "";
        photoEl.src = p.photoUrl || ""; photoEl.alt = p.name || "";
        qtyEl.textContent = p.quantity ?? 0;
      });
    }

    // Subscribe + render newest-first history
    function subscribeHistory(id){
      const qRef = query(ref(db,'transactions'), orderByChild('productId'), equalTo(id));
      onValue(qRef, (snap)=>{
        const txns = [];
        snap.forEach(c => txns.push({ id: c.key, ...c.val() }));
        // sort NEWEST -> OLDEST by 'at'
        txns.sort((a,b) => (b.at || 0) - (a.at || 0));

        if (txns.length === 0) {
          historyBody.innerHTML = "";
          show(historyEmpty, true);
          return;
        }
        show(historyEmpty, false);
        historyBody.innerHTML = txns.map(t => {
          const when = t.at ? new Date(t.at).toLocaleString() : '';
          const who  = t.byEmail || t.by || '';
          const change = (t.delta > 0 ? '+' : '') + (t.delta ?? 0);
          const start = (t.startingQty ?? '');
          const end   = (t.endingQty   ?? '');
          return `
            <tr class="border-t border-slate-800/60">
              <td class="px-3 py-2">${when}</td>
              <td class="px-3 py-2">${who}</td>
              <td class="px-3 py-2 text-right">${start}</td>
              <td class="px-3 py-2 text-right">${change}</td>
              <td class="px-3 py-2 text-right">${end}</td>
            </tr>
          `;
        }).join('');
      }, (err) => {
        console.error("history listener error:", err);
        historyBody.innerHTML = "";
        show(historyEmpty, true);
        historyEmpty.textContent = "History unavailable (rules/index).";
      });
    }

    // Pending logic
    minusBtn.onclick = () => { pending -= 1; renderPending(); };
    plusBtn.onclick  = () => { pending += 1; renderPending(); };
    cancelBtn.onclick = () => { pending = 0; renderPending(); };

    // Submit: atomic qty update + compliant transaction (includes required 'type')
    submitBtn.onclick = async () => {
      if (!pending) return;
      const delta = pending;
      pending = 0; renderPending();

      try {
        const uid   = auth.currentUser.uid;
        const email = auth.currentUser.email || uid;

        // Atomically compute starting & ending qty and apply it
        let startVal = null, endVal = null;
        await runTransaction(ref(db,`products/${pid}/quantity`), q => {
          startVal = q || 0;
          endVal   = startVal + delta;
          return endVal;
        });

        // Write transaction row with all required/desired fields
        const txnRef = push(ref(db,'transactions'));
        await update(txnRef, {
          productId: pid,
          type: delta > 0 ? 'add' : 'remove',  // REQUIRED by rules
          delta,
          by: uid,
          byEmail: email,
          note: (noteEl.value || '').trim() || null,
          at: serverTimestamp(),
          startingQty: startVal,
          endingQty: endVal
        });

        // Stamp product metadata
        await update(ref(db,`products/${pid}`), {
          updatedBy: uid,
          updatedAt: serverTimestamp()
        });

        toast(`Saved ${delta > 0 ? '+' : ''}${delta}`);
        noteEl.value = '';
      } catch (e) {
        console.error(e);
        toast("Submit failed. Check connection.");
        pending = delta; renderPending();
      }
    };
  </script>
</body>
</html>
