<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Inventory</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-slate-950 text-slate-100">
  <main class="max-w-xl mx-auto p-3 sm:p-4 space-y-4">
    <div id="authBar" class="flex items-center justify-between text-xs sm:text-sm opacity-80"></div>

    <!-- Sign-in -->
    <section id="login" class="space-y-2">
      <h2 class="text-lg font-semibold">Sign in</h2>
      <input id="email" class="w-full px-3 py-2 rounded bg-slate-800" placeholder="Email" autocomplete="username">
      <input id="pass" type="password" class="w-full px-3 py-2 rounded bg-slate-800" placeholder="Password" autocomplete="current-password">
      <button id="loginBtn" class="w-full sm:w-auto px-4 py-2 rounded bg-blue-600">Sign in</button>
      <div id="toast" class="hidden mt-3 text-center text-sm"></div>
    </section>

    <!-- Product card -->
    <section id="product" class="hidden">
      <div class="rounded-2xl bg-slate-900/60 p-3 sm:p-4">
        <div class="flex items-start gap-3">
          <img id="photo" class="w-16 h-16 sm:w-20 sm:h-20 rounded-xl object-cover bg-slate-800" alt=""/>
          <div class="min-w-0">
            <h1 id="name" class="text-lg sm:text-xl font-semibold truncate"></h1>
            <div id="sku" class="text-xs opacity-70 truncate"></div>
            <div id="location" class="text-xs opacity-70 truncate"></div>
          </div>
        </div>

        <div class="mt-3 sm:mt-4 text-center">
          <div class="text-[10px] sm:text-xs uppercase tracking-wider opacity-70">On Hand</div>
          <div id="qty" class="text-5xl sm:text-6xl font-bold my-2">–</div>
        </div>

        <!-- Adjustment controls -->
        <div class="mt-2 sm:mt-3 flex items-center justify-center gap-3 sm:gap-4">
          <button id="minusBtn" class="text-3xl w-24 h-24 sm:w-20 sm:h-20 rounded-2xl bg-slate-800 active:scale-95">−</button>
          <button id="plusBtn"  class="text-3xl w-24 h-24 sm:w-20 sm:h-20 rounded-2xl bg-slate-800 active:scale-95">+</button>
        </div>

        <!-- Pending + Submit/Cancel -->
        <div class="mt-3 flex flex-col sm:flex-row items-center justify-center gap-2 sm:gap-3">
          <span id="pendingBadge" class="px-3 py-1 rounded-full text-sm bg-slate-800/70 hidden">Pending 0</span>
          <div class="flex gap-2">
            <button id="submitBtn" class="px-4 py-2 rounded-xl bg-blue-600 disabled:opacity-40" disabled>Submit</button>
            <button id="cancelBtn" class="px-4 py-2 rounded-xl bg-slate-700 disabled:opacity-40" disabled>Cancel</button>
          </div>
        </div>

        <div class="mt-3">
          <input id="note" placeholder="Optional note" class="w-full px-3 py-2 rounded-xl bg-slate-800/70"/>
        </div>

        <!-- History (tiles) -->
        <div class="mt-5">
          <button id="toggleHistory" class="w-full flex items-center justify-between px-3 py-2 rounded-lg bg-slate-900/70">
            <span class="text-sm font-semibold">History</span>
            <span id="chev" class="text-xs opacity-70">Show</span>
          </button>

          <div id="historyWrap" class="hidden mt-2">
            <div id="historyEmpty" class="hidden p-3 text-xs opacity-70">No history yet.</div>
            <div id="historyTiles" class="space-y-2"></div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { getDatabase, ref, onValue, runTransaction, push, update, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAy8uJsjPrdHKp60afCtnTdYGLHoYTEHyc",
      authDomain: "artsinventorymachine.firebaseapp.com",
      databaseURL: "https://artsinventorymachine-default-rtdb.firebaseio.com",
      projectId: "artsinventorymachine",
      storageBucket: "artsinventorymachine.firebasestorage.app",
      messagingSenderId: "1003904050464",
      appId: "1:1003904050464:web:5a35989900fbdc5fa72345",
      measurementId: "G-BEJKKJK9H5"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // Helpers
    const $ = (x)=>document.getElementById(x);
    const show = (el, yes)=> el.classList.toggle("hidden", !yes);
    const q = (k,d=null)=> new URLSearchParams(location.search).get(k) || d;
    const toastEl = document.getElementById("toast") || document.createElement("div");
    const toast=(m)=>{ toastEl.textContent=m; toastEl.className="mt-3 text-center text-sm"; show(toastEl,true); setTimeout(()=>show(toastEl,false),3000); };

    let pid = null, pending = 0;

    const loginSec = $("login"), prodSec = $("product"), authBar = $("authBar");
    const nameEl = $("name"), skuEl = $("sku"), locEl = $("location"), qtyEl = $("qty"), photoEl = $("photo");
    const minusBtn = $("minusBtn"), plusBtn = $("plusBtn"), noteEl = $("note");
    const pendingBadge = $("pendingBadge"), submitBtn = $("submitBtn"), cancelBtn = $("cancelBtn");

    // History UI
    const toggleHistoryBtn = $("toggleHistory"), historyWrap = $("historyWrap"), chev = $("chev");
    const historyTiles = $("historyTiles"), historyEmpty = $("historyEmpty");

    // Collapsible history toggle
    toggleHistoryBtn?.addEventListener("click", () => {
      const open = historyWrap.classList.contains("hidden");
      if (open) { historyWrap.classList.remove("hidden"); chev.textContent = "Hide"; }
      else { historyWrap.classList.add("hidden"); chev.textContent = "Show"; }
    });

    function renderPending() {
      if (pending === 0) {
        pendingBadge.classList.add("hidden");
        submitBtn.disabled = true;
        cancelBtn.disabled = true;
        pendingBadge.textContent = "Pending 0";
      } else {
        pendingBadge.classList.remove("hidden");
        submitBtn.disabled = false;
        cancelBtn.disabled = false;
        const sign = pending > 0 ? "+" : "";
        pendingBadge.textContent = `Pending ${sign}${pending}`;
      }
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) { authBar.innerHTML = ""; show(loginSec, true); show(prodSec, false); return; }
      authBar.innerHTML = `Signed in as <b>${user.email}</b> — <button id="logout" class="underline">Sign out</button>`;
      document.getElementById("logout").onclick = () => signOut(auth);
      show(loginSec, false);

      pid = q("id") || "prod_demo";
      bindProduct(pid);
      subscribeHistoryTiles(pid);  // tiles renderer
      renderPending();
      show(prodSec, true);
    });

    $("loginBtn").onclick = async () => {
      try {
        await signInWithEmailAndPassword(auth, $("email").value.trim(), $("pass").value.trim());
      } catch(e) {
        toast(`Sign-in failed: ${e.code}`);
      }
    };

    function bindProduct(id){
      onValue(ref(db, `products/${id}`), (snap) => {
        if (!snap.exists()) { nameEl.textContent = "Not found"; return; }
        const p = snap.val();
        nameEl.textContent = p.name || "(unnamed)";
        skuEl.textContent = p.sku ? `SKU: ${p.sku}` : "";
        locEl.textContent = p.location ? `Location: ${p.location}` : "";
        photoEl.src = p.photoUrl || ""; photoEl.alt = p.name || "";
        qtyEl.textContent = p.quantity ?? 0;
      });
    }

    // Tiles history: read all /transactions, filter by productId, newest first
    function subscribeHistoryTiles(id){
      onValue(ref(db,'transactions'), (snap)=>{
        const txns = [];
        snap.forEach(c => {
          const t = { id: c.key, ...c.val() };
          if (t.productId === id) txns.push(t);
        });
        txns.sort((a,b) => (b.at || 0) - (a.at || 0)); // NEWEST first
        if (txns.length === 0) {
          historyTiles.innerHTML = "";
          historyEmpty.classList.remove("hidden");
          return;
        }
        historyEmpty.classList.add("hidden");
        historyTiles.innerHTML = txns.map(t => tileHTML(t)).join('');
      }, (err)=>{
        console.error("history listener error:", err);
        historyTiles.innerHTML = "";
        historyEmpty.classList.remove("hidden");
        historyEmpty.textContent = "History unavailable.";
      });
    }

    // Render one history tile (card)
    function tileHTML(t){
      const when = t.at ? new Date(t.at).toLocaleString() : '';
      const who  = t.byEmail || t.by || '';
      const delta = Number(t.delta || 0);
      const change = (delta > 0 ? `+${delta}` : `${delta}`);
      const start = (t.startingQty ?? '');
      const end   = (t.endingQty   ?? '');
      const note  = t.note ? String(t.note) : '';

      const badgeClass = delta >= 0 ? "bg-emerald-700/30 text-emerald-200" : "bg-rose-700/30 text-rose-200";

      return `
        <div class="rounded-xl bg-slate-900/50 p-3">
          <div class="flex items-center justify-between gap-2">
            <div class="text-xs opacity-80">${when}</div>
            <span class="text-xs px-2 py-1 rounded-full ${badgeClass}">${change}</span>
          </div>

          <div class="mt-2 grid grid-cols-2 gap-x-4 gap-y-1 text-sm">
            <div class="opacity-70">User</div>
            <div class="truncate">${who}</div>

            <div class="opacity-70">Starting</div>
            <div class="text-right">${start}</div>

            <div class="opacity-70">Ending</div>
            <div class="text-right font-semibold">${end}</div>
          </div>

          ${note ? `<div class="mt-2 text-xs opacity-80"><span class="opacity-70">Note:</span> ${escapeHTML(note)}</div>` : ``}
        </div>
      `;
    }

    // Basic HTML escape for notes
    function escapeHTML(s){
      return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    // Pending logic
    minusBtn.onclick = () => { pending -= 1; renderPending(); };
    plusBtn.onclick  = () => { pending += 1; renderPending(); };
    cancelBtn.onclick = () => { pending = 0; renderPending(); };

    // Submit: atomic qty update + compliant transaction
    submitBtn.onclick = async () => {
      if (!pending) return;
      const delta = pending;
      pending = 0; renderPending();

      try {
        const uid   = auth.currentUser.uid;
        const email = auth.currentUser.email || uid;

        // Atomically compute starting & ending qty and apply it
        let startVal = null, endVal = null;
        await runTransaction(ref(db,`products/${pid}/quantity`), q => {
          startVal = q || 0;
          endVal   = startVal + delta;
          return endVal;
        });

        // Write transaction row
        const txnRef = push(ref(db,'transactions'));
        await update(txnRef, {
          productId: pid,
          type: delta > 0 ? 'add' : 'remove',
          delta,
          by: uid,
          byEmail: email,
          note: (noteEl.value || '').trim() || null,
          at: serverTimestamp(),
          startingQty: startVal,
          endingQty: endVal
        });

        // Stamp product metadata
        await update(ref(db,`products/${pid}`), {
          updatedBy: uid,
          updatedAt: serverTimestamp()
        });

        toast(`Saved ${delta > 0 ? '+' : ''}${delta}`);
        noteEl.value = '';
      } catch (e) {
        console.error(e);
        toast("Submit failed. Check connection.");
        pending = delta; renderPending();
      }
    };
  </script>
</body>
</html>
