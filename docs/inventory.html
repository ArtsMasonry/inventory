<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inventory</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-slate-950 text-slate-100">
  <main class="max-w-xl mx-auto p-4 space-y-4">
    <header class="flex items-center justify-between text-xs opacity-80">
      <div id="authBar"></div>
    </header>

    <!-- Auth -->
    <section id="login" class="space-y-2">
      <h2 class="text-lg font-semibold">Sign in</h2>
      <input id="email" class="w-full px-3 py-2 rounded bg-slate-800" placeholder="Email" autocomplete="username">
      <input id="pass" type="password" class="w-full px-3 py-2 rounded bg-slate-800" placeholder="Password" autocomplete="current-password">
      <div class="flex gap-2">
        <button id="loginBtn" class="px-4 py-2 rounded bg-blue-600">Sign in</button>
        <button id="signupBtn" class="px-4 py-2 rounded bg-slate-700">Create account</button>
      </div>
      <div id="authMsg" class="text-sm text-rose-300 hidden"></div>
    </section>

    <!-- Product -->
    <section id="product" class="hidden">
      <div class="rounded-2xl bg-slate-900/60 p-4">
        <div class="flex items-start gap-3">
          <img id="photo" class="w-20 h-20 rounded-xl object-cover bg-slate-800" alt=""/>
          <div>
            <h1 id="name" class="text-xl font-semibold"></h1>
            <div id="location" class="text-xs opacity-70"></div>
          </div>
        </div>

        <div class="mt-4 text-center">
          <div class="text-xs uppercase tracking-wider opacity-70">On Hand</div>
          <div id="qty" class="text-5xl font-bold my-2">–</div>
        </div>

        <!-- +/- -->
        <div class="mt-3 flex items-center justify-center gap-4">
          <button id="minusBtn" class="text-3xl w-20 h-20 rounded-2xl bg-slate-800">−</button>
          <button id="plusBtn"  class="text-3xl w-20 h-20 rounded-2xl bg-slate-800">+</button>
        </div>

        <!-- Pending + Submit/Cancel -->
        <div class="mt-3 flex items-center justify-center gap-3">
          <span id="pendingBadge" class="px-3 py-1 rounded-full text-sm bg-slate-800/70 hidden">Pending 0</span>
          <button id="submitBtn" class="px-4 py-2 rounded-xl bg-blue-600 disabled:opacity-40" disabled>Submit</button>
          <button id="cancelBtn" class="px-4 py-2 rounded-xl bg-slate-700 disabled:opacity-40" disabled>Cancel</button>
        </div>

        <div class="mt-3">
          <input id="note" placeholder="Optional note (job / reason)" class="w-full px-3 py-2 rounded-xl bg-slate-800/70"/>
        </div>

        <div id="toast" class="hidden mt-3 text-center text-sm"></div>

        <!-- History -->
        <div class="mt-5">
          <div class="text-sm font-semibold mb-2">History</div>
          <div id="history" class="space-y-2"></div>
        </div>
      </div>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { getDatabase, ref, onValue, runTransaction, push, update, serverTimestamp, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAy8uJsjPrdHKp60afCtnTdYGLHoYTEHyc",
      authDomain: "artsinventorymachine.firebaseapp.com",
      databaseURL: "https://artsinventorymachine-default-rtdb.firebaseio.com",
      projectId: "artsinventorymachine",
      messagingSenderId: "1003904050464",
      appId: "1:1003904050464:web:5a35989900fbdc5fa72345",
      measurementId: "G-BEJKKJK9H5"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // Helpers
    const $ = (x)=>document.getElementById(x);
    const show = (el, yes)=> el.classList.toggle("hidden", !yes);
    const q = (k,d=null)=> new URLSearchParams(location.search).get(k) || d;
    const toastEl = $("toast");
    const toast=(m)=>{ toastEl.textContent=m; toastEl.classList.remove("hidden"); setTimeout(()=>toastEl.classList.add("hidden"),3000); };
    const esc = s => (s||"").replace(/[&<>"]/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c]));

    // Elements
    const loginSec=$("login"), prodSec=$("product"), authBar=$("authBar");
    const nameEl=$("name"), locEl=$("location"), qtyEl=$("qty"), photoEl=$("photo");
    const minusBtn=$("minusBtn"), plusBtn=$("plusBtn"), noteEl=$("note");
    const pendingBadge=$("pendingBadge"), submitBtn=$("submitBtn"), cancelBtn=$("cancelBtn");
    const histEl=$("history"), authMsg=$("authMsg");

    let pid=null, pending=0, liveQty=0;

    function renderPending(){
      if(pending===0){
        pendingBadge.classList.add("hidden");
        submitBtn.disabled=true; cancelBtn.disabled=true;
      }else{
        pendingBadge.classList.remove("hidden");
        submitBtn.disabled=false; cancelBtn.disabled=false;
        pendingBadge.textContent = `Pending ${pending>0?'+':''}${pending}`;
      }
    }

    onAuthStateChanged(auth, (user)=>{
      if(!user){ authBar.innerHTML=""; show(loginSec,true); show(prodSec,false); return; }
      authBar.innerHTML = `Signed in as <b>${user.email}</b> — <button id="logout" class="underline">Sign out</button>`;
      document.getElementById("logout").onclick = () => signOut(auth);
      show(loginSec,false);

      pid = q("id") || "prod_demo";
      bindProduct(pid);
      loadHistory(pid);
      renderPending();
      show(prodSec,true);
    });

    // Login / Signup
    $("loginBtn").onclick = async () => {
      try { await signInWithEmailAndPassword(auth, $("email").value.trim(), $("pass").value.trim()); authMsg.classList.add("hidden"); }
      catch(e){ authMsg.textContent=e.code || "Sign-in failed"; authMsg.classList.remove("hidden"); }
    };
    $("signupBtn").onclick = async () => {
      try { await createUserWithEmailAndPassword(auth, $("email").value.trim(), $("pass").value.trim()); authMsg.classList.add("hidden"); }
      catch(e){ authMsg.textContent=e.code || "Sign-up failed"; authMsg.classList.remove("hidden"); }
    };

    function bindProduct(id){
      onValue(ref(db, `products/${id}`), (snap)=>{
        if(!snap.exists()){ nameEl.textContent="Not found"; return; }
        const p=snap.val();
        nameEl.textContent = p.name || "(unnamed)";
        locEl.textContent = p.location ? `Location: ${p.location}` : "";
        photoEl.src = p.photoUrl || ""; photoEl.alt = p.name || "";
        liveQty = Number(p.quantity||0);
        qtyEl.textContent = liveQty;
      });
    }

    function loadHistory(id){
      onValue(query(ref(db,'transactions'), orderByChild('productId'), equalTo(id)), (snap)=>{
        const rows=[]; snap.forEach(s=>rows.push({id:s.key, ...s.val()}));
        rows.sort((a,b)=>(b.at||0)-(a.at||0)); // newest first
        histEl.innerHTML = rows.slice(0,50).map(t=>{
          const when=t.at?new Date(t.at).toLocaleString():"";
          const delta=t.delta>0?`+${t.delta}`:`${t.delta}`;
          const uid=(t.by||"").slice(0,8);
          const start=t.startQty ?? "–";
          const end=t.endQty ?? "–";
          const note=t.note?`<div class="mt-1 text-[11px] opacity-70">Note: ${esc(t.note)}</div>`:"";
          return `<div class="rounded-lg bg-slate-900/70 p-3">
              <div class="flex justify-between text-sm">
                <div class="font-medium">${when}</div>
                <div class="font-semibold ${t.delta>=0?'text-emerald-300':'text-rose-300'}">${delta}</div>
              </div>
              <div class="mt-1 grid grid-cols-2 gap-2 text-xs opacity-80">
                <div><span class="opacity-60">User:</span> ${uid}</div>
                <div><span class="opacity-60">Start:</span> ${start}</div>
                <div><span class="opacity-60">End:</span> ${end}</div>
              </div>
              ${note}
            </div>`;
        }).join("");
      });
    }

    // Pending / Submit
    minusBtn.onclick = ()=>{ pending-=1; renderPending(); };
    plusBtn.onclick  = ()=>{ pending+=1; renderPending(); };
    cancelBtn.onclick= ()=>{ pending=0; renderPending(); };

    submitBtn.onclick = async ()=>{
      if(!pending) return;
      const delta=pending; pending=0; renderPending();
      try{
        const uid=auth.currentUser.uid;
        const startQty=liveQty; const endQty=startQty+delta;
        const txnRef=push(ref(db,'transactions'));
        await update(txnRef,{ productId:pid, type:delta>0?'add':'remove', delta, by:uid, at:serverTimestamp(), startQty, endQty, note: noteEl.value.trim()||null });
        await runTransaction(ref(db,`products/${pid}/quantity`), q=>(q||0)+delta);
        await update(ref(db,`products/${pid}`), { updatedBy: uid, updatedAt: serverTimestamp() });
        noteEl.value=''; 
        toast(`Saved ${delta>0?'+':''}${delta}`);
      }catch(e){ console.error(e); toast("Submit failed. Permissions/connection."); pending=delta; renderPending(); }
    };
  </script>
</body>
</html>
